---
- name: Install dnsmasq
  apt:
    package: dnsmasq
    update_cache: yes

- name: Stop and disable systemd-resolve
  systemd:
    name: systemd-resolved
    enabled: no
    state: stopped
  ignore_errors: yes

- name: Create the dnsmasq systemd drop-in configuration directory
  file:
    path: '{{ dnsmasq_systemd_path }}'
    state: directory

- name: Generate the dnsmasq systemd drop-in service file
  template:
    src: dnsmasq.service.j2
    dest: '{{ dnsmasq_systemd_path }}/10-restart-failure.conf'
    mode: 0644

- name: Enable the dnsmasq service
  systemd:
    daemon_reload: yes
    enabled: yes
    name: dnsmasq
    state: restarted

- name: Copy own resolv.conf
  copy:
    src: resolv.conf
    dest: /etc/resolv.conf
    attributes: +i
  tags: ['resolv']
